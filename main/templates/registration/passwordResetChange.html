{% extends "base.html" %}
{% load crispy_forms_tags %}

{%block head%}
<script>
  document.addEventListener("DOMContentLoaded", function(){  
    axios.defaults.xsrfHeaderName = "X-CSRFTOKEN";
    axios.defaults.xsrfCookieName = "csrftoken";

    var app = Vue.createApp({
    
      delimiters: ['[[', ']]'],

      data() {return{
        buttonText : 'Change Password <i class="fas fa-sign-in-alt"></i>',
        messageText : "",
        changeMode:1,
        form_ids : {{form_ids|safe}},     
        password1:null,
        password2:null,                     
      }},

      methods:{
        //get current, last or next month

        change_password:function change_password(){
          app.buttonText = '<i class="fas fa-spinner fa-spin"></i>';
          app.messageText = "";

          axios.post('/accounts/passwordResetChange/{{token}}', {
                  action :"change_password",
                  formData : {
                    password1 : app.password1,
                    password2 : app.password2, 
                  }
                                              
              })
              .then(function (response) {     
                  
                status=response.data.status;                               

                app.clearMainFormErrors();

                if(status == "validation")
                {              
                  //form validation error           
                  app.displayErrors(response.data.errors);
                }
                else if(status == "error")
                {
                  app.messageText = response.data.message;
                }
                else
                {
                  app.changeMode = 2;
                }

                app.buttonText = 'Change Password <i class="fas fa-sign-in-alt"></i>';

              })
              .catch(function (error) {
                  console.log(error);                            
              });                        
            },

        clearMainFormErrors:function clearMainFormErrors(){

          s = app.form_ids;                    
          for(var i in s)
          {
            let e = document.getElementById("id_errors_" + s[i]);
            if(e) e.remove();
          }

        },
        
        //display form errors
        displayErrors: function displayErrors(errors){
              for(let e in errors)
              {
                  let str='<span id=id_errors_'+ e +' class="text-danger">';
                  
                  for(let i in errors[e])
                  {
                      str +=errors[e][i] + '<br>';
                  }

                  str+='</span>';

                  document.getElementById("div_id_" + e).insertAdjacentHTML('beforeend', str);
                   //scroll to the last error
                  var elmnt =  document.getElementById("div_id_" + e);
                  if(elmnt) elmnt.scrollIntoView(); 
              }
          }, 

          
      },            

      mounted(){
                                  
      },
    }).mount('#app');
  });

</script>
{%endblock head%}

{% block content %}
    <div class="row justify-content-lg-center">
        <div class="col col-lg-6">
          <div class="card">
            <div class="card-header">
              Update Password
            </div>
      
            <div class="card-body">        
              {%if valid_code%}
                <div v-if="changeMode===1">  
                  <form id="password_reset_change_form" v-on:submit.prevent="change_password()">
                    {% csrf_token %}    
                    <div class="row">
                        <div class = "col col-lg-8 offset-lg-2">  
                            {{ form.password1|as_crispy_field }}           
                        </div>            
                    </div>  
                    <div class="row">
                        <div class = "col col-lg-8 offset-lg-2">  
                            {{ form.password2|as_crispy_field }}          
                        </div>            
                    </div>
                  </form>
  
                  <div class="row">
                      <div class="col col-lg-8 offset-lg-2">
                          <button type="submit" class="btn btn-outline-primary" v-on:click="change_password">
                            <span v-html="buttonText"></span>
                          </button>
                      </div>
                  </div>
                </div>
                <div v-else>
                  <div class="row">
                    <div class="col" style="text-align: center;">
                      <br>
                      Your password has been updated, log in again:<br>
                      <a href="{%url 'login'%}">Log In</a>
                    </div>
                  </div>
                </div>         
                        

              {% else %}

                  <div class="row">
                      <div class="col">
                          <Center>
                          The password reset link was invalid, possibly because it has already been used.<br><br>
                          Please request a new password reset.<br>
                          <a href="{% url 'passwordReset' %}">Send New Link</a>
                          </center>
                      </div>
                  </div>
              {% endif %}
                
              </form>    
            </div>
          </div>
        </div>
      </div>
{% endblock %}